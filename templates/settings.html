<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settings - English Exam Generator</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            padding-top: 2rem;
            padding-bottom: 2rem;
            background-color: #f8f9fa;
        }
        .navbar {
            margin-bottom: 2rem;
        }
        .key-preview {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            background-color: #f8f9fa;
            border-radius: 0.25rem;
            border: 1px solid #dee2e6;
            font-family: monospace;
            margin-left: 0.5rem;
        }
        .settings-section {
            margin-bottom: 2rem;
        }
        .section-card {
            margin-bottom: 2rem;
        }
    </style>
</head>
<body>
    {% set active_page = 'settings' %}
    {% include '_navbar.html' %}

    <div class="container">
        <h1 class="mb-4">Settings</h1>
        
        <!-- Success/Error Messages -->
        {% if upload_message %}
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            {{ upload_message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        {% endif %}
        
        {% if upload_error %}
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            {{ upload_error }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        {% endif %}

        <div class="row">
            <div class="col-md-6">
                <!-- AI Settings -->
                <div class="card settings-section">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">AI Reformatting Settings</h5>
                    </div>
                    <div class="card-body">
                        <!-- API Key Form -->
                        <form method="post" class="mb-4">
                            <div class="mb-3">
                                <label for="api_key" class="form-label">OpenAI API Key</label>
                                <input type="password" class="form-control" id="api_key" name="api_key" placeholder="Enter new key to update">
                                <div class="form-text">
                                    {% if api_key_preview == "Not set" %}
                                        Your OpenAI API key is not set.
                                    {% else %}
                                        An API key is already set ({{ api_key_preview }}). To change it, enter a new key above.
                                    {% endif %}
                                </div>
                            </div>
                            <button type="submit" name="save_api_key" class="btn btn-primary">Save API Key</button>
                        </form>

                        <hr>

                        <!-- Model Selection Form -->
                        <form method="post">
                            <div class="mb-3">
                                <label for="model" class="form-label">AI Model</label>
                                <select class="form-select" id="model" name="model">
                                    <option value="gpt-4o" {% if model == 'gpt-4o' %}selected{% endif %}>GPT-4o</option>
                                    <option value="gpt-4-turbo-preview" {% if model == 'gpt-4-turbo-preview' %}selected{% endif %}>GPT-4 Turbo Preview</option>
                                    <option value="gpt-3.5-turbo" {% if model == 'gpt-3.5-turbo' %}selected{% endif %}>GPT-3.5 Turbo</option>
                                    <option value="o4-mini-2025-04-16" {% if model == 'o4-mini-2025-04-16' %}selected{% endif %}>O4 Mini</option>
                                    <option value="gpt-4.1-2025-04-14" {% if model == 'gpt-4.1-2025-04-14' %}selected{% endif %}>GPT 4.1</option>
                                    <option value="o3-2025-04-16" {% if model == 'o3-2025-04-16' %}selected{% endif %}>O3</option>
                                </select>
                                <div class="form-text">Current model: <strong>{{ model }}</strong>. Select a new model to use for question reformatting.</div>
                            </div>
                            <button type="submit" name="save_model" class="btn btn-primary">Save Model</button>
                        </form>
                    </div>
                </div>

                <!-- Prompt Settings -->
                <div class="card settings-section">
                    <div class="card-header bg-secondary text-white">
                        <h5 class="mb-0">AI Prompt Settings</h5>
                    </div>
                    <div class="card-body">
                        <form method="post" onsubmit="return confirm('Are you sure you want to save this prompt? The previous one will be permanently replaced.');">
                            <div class="mb-3">
                                <label for="prompt" class="form-label">AI Reformatting Prompt</label>
                                <textarea class="form-control" id="prompt" name="prompt" rows="15">{{ prompt }}</textarea>
                                <div class="form-text">
                                    Edit the prompt used for AI reformulations. Use placeholders like <code>{correct_answer}</code>, <code>{question_body}</code>, and <code>{answers_json}</code>.
                                </div>
                            </div>
                            
                            <div class="alert alert-warning">
                                <strong>Warning:</strong> Modifying the prompt can significantly affect the quality and format of AI reformulations.
                            </div>

                            <button type="submit" name="save_prompt" class="btn btn-warning">Save Prompt</button>
                        </form>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <!-- File Downloads -->
                <div class="card settings-section">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">Download Data Files</h5>
                    </div>
                    <div class="card-body">
                        <p>Download your current data files for backup or sharing:</p>
                        <div class="d-grid gap-2">
                            <a href="/download_questions" class="btn btn-outline-success">
                                Download Questions Database (questions.json)
                            </a>
                            <a href="/download_tags" class="btn btn-outline-success">
                                Download Tags & Chapters (tags_and_chapters.json)
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Upload Questions -->
                <div class="card settings-section">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="mb-0">Upload Questions Database</h5>
                    </div>
                    <div class="card-body">
                        <form method="post" enctype="multipart/form-data">
                            <div class="mb-3">
                                <label for="questions_file" class="form-label">Upload New Questions File</label>
                                <input type="file" class="form-control" id="questions_file" name="questions_file" accept=".json" required>
                                <div class="form-text">Upload a JSON file containing questions. This will replace your current questions database.</div>
                            </div>
                            
                            <div class="alert alert-warning">
                                <strong>Warning:</strong> This will replace your current questions database. Make sure to download a backup first.
                            </div>
                            
                            <button type="submit" class="btn btn-warning">Upload Questions</button>
                        </form>
                    </div>
                </div>

                <!-- Upload Tags & Chapters -->
                <div class="card settings-section">
                    <div class="card-header bg-secondary text-white">
                        <h5 class="mb-0">Upload Tags & Chapters</h5>
                    </div>
                    <div class="card-body">
                        <form method="post" enctype="multipart/form-data">
                            <div class="mb-3">
                                <label for="tags_file" class="form-label">Upload Tags & Chapters File</label>
                                <input type="file" class="form-control" id="tags_file" name="tags_file" accept=".json" required>
                                <div class="form-text">Upload a JSON file containing tags and chapters. This will replace your current tag configuration.</div>
                            </div>
                            
                            <div class="alert alert-info">
                                <strong>Note:</strong> This will replace your current tags and chapters configuration. Questions will remain unchanged.
                            </div>
                            
                            <button type="submit" class="btn btn-secondary">Upload Tags & Chapters</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-12">
                <div class="alert alert-info">
                    <h6><strong>File Format Information:</strong></h6>
                    <ul class="mb-0">
                        <li><strong>Questions File:</strong> Should be a JSON array of question objects with body, answers, correct_answer, topic, category, year, and optional tags fields.</li>
                        <li><strong>Tags & Chapters File:</strong> Should be a JSON object with "tags" and "chapters" keys. See the downloaded file for the exact format.</li>
                        <li><strong>Backward Compatibility:</strong> The system automatically synchronizes tags when you upload questions files from previous versions.</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html> 