<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settings - English Exam Generator</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            padding-top: 2rem;
            padding-bottom: 2rem;
            background-color: #f8f9fa;
        }
        .navbar {
            margin-bottom: 2rem;
        }
        .key-preview {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            background-color: #f8f9fa;
            border-radius: 0.25rem;
            border: 1px solid #dee2e6;
            font-family: monospace;
            margin-left: 0.5rem;
        }
        .settings-section {
            margin-bottom: 2rem;
        }
        .section-card {
            margin-bottom: 2rem;
        }
    </style>
</head>
<body>
    {% set active_page = 'settings' %}
    {% include '_navbar.html' %}

    <div class="container">
        <h1 class="mb-4">Settings</h1>
        
        {% if current_user and current_user.is_authenticated and current_user.is_superadmin() %}
        <!-- User Management Section -->
        <div class="alert alert-info d-flex justify-content-between align-items-center mb-4">
            <div>
                <i class="fas fa-shield-alt me-2"></i>
                <strong>Superadmin Access:</strong> You have access to advanced user management features.
            </div>
            <a href="{{ url_for('manage_users') }}" class="btn btn-primary btn-sm">
                <i class="fas fa-users me-1"></i> Manage Users
            </a>
        </div>
        {% endif %}
        
        <!-- Success/Error Messages -->
        {% if upload_message %}
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            {{ upload_message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        {% endif %}
        
        {% if upload_error %}
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            {{ upload_error }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        {% endif %}

        <div class="row">
            <div class="col-md-6">
                <!-- AI Settings -->
                <div class="card settings-section">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">AI Reformatting Settings</h5>
                    </div>
                    <div class="card-body">
                        <!-- OpenAI API Key Form -->
                        <form method="post" class="mb-3">
                            <div class="mb-3">
                                <label for="openai_api_key" class="form-label">OpenAI API Key</label>
                                <input type="password" class="form-control" id="openai_api_key" name="openai_api_key" placeholder="Enter new key to update">
                                <div class="form-text">
                                    {% if openai_api_key_preview == "Not set" %}
                                        Your OpenAI API key is not set.
                                    {% else %}
                                        An API key is already set ({{ openai_api_key_preview }}). To change it, enter a new key above.
                                    {% endif %}
                                </div>
                            </div>
                            <button type="submit" name="save_openai_api_key" class="btn btn-primary">Save OpenAI Key</button>
                        </form>

                        <!-- Gemini API Key Form -->
                        <form method="post" class="mb-4">
                            <div class="mb-3">
                                <label for="gemini_api_key" class="form-label">Gemini API Key</label>
                                <input type="password" class="form-control" id="gemini_api_key" name="gemini_api_key" placeholder="Enter new key to update">
                                <div class="form-text">
                                    {% if gemini_api_key_preview == "Not set" %}
                                        Your Gemini API key is not set.
                                    {% else %}
                                        An API key is already set ({{ gemini_api_key_preview }}). To change it, enter a new key above.
                                    {% endif %}
                                </div>
                            </div>
                            <button type="submit" name="save_gemini_api_key" class="btn btn-primary">Save Gemini Key</button>
                        </form>

                        <hr>
                            
                        <!-- Model Selection Form -->
                        <form method="post">
                            <div class="mb-3">
                                <label for="model" class="form-label">AI Model</label>
                                <select class="form-select" id="model" name="model">
                                    <optgroup label="OpenAI Models">
                                        <option value="gpt-4o" {% if model == 'gpt-4o' %}selected{% endif %}>GPT-4o</option>
                                        <option value="gpt-4-turbo" {% if model == 'gpt-4-turbo' %}selected{% endif %}>GPT-4 Turbo</option>
                                        <option value="gpt-3.5-turbo" {% if model == 'gpt-3.5-turbo' %}selected{% endif %}>GPT-3.5 Turbo</option>
                                        <option value="gpt-4.1" {% if model == 'gpt-4.1' %}selected{% endif %}>GPT-4.1</option>
                                        <option value="o4-mini" {% if model == 'o4-mini' %}selected{% endif %}>O4 Mini</option>
                                    </optgroup>
                                    <optgroup label="Google Gemini Models">
                                        <option value="gemini-2.5-pro" {% if model == 'gemini-2.5-pro' %}selected{% endif %}>Gemini 2.5 Pro</option>
                                        <option value="gemini-2.5-flash" {% if model == 'gemini-2.5-flash' %}selected{% endif %}>Gemini 2.5 Flash</option>
                                    </optgroup>
                                </select>
                                <div class="form-text">Current model: <strong>{{ model }}</strong>. The system will automatically use the appropriate API key based on your selection.</div>
                            </div>
                            <button type="submit" name="save_model" class="btn btn-primary">Save Model</button>
                        </form>

                        <hr>

                        <!-- AI Reformatting Options -->
                        <form method="post">
                            <h6 class="mb-3">Reformatting Options</h6>
                            
                            <div class="mb-3">
                                <label for="num_variations" class="form-label">Number of Variations</label>
                                <input type="number" class="form-control" id="num_variations" name="num_variations" 
                                       min="1" max="10" value="{{ num_variations }}" required>
                                <div class="form-text">Number of alternative formulations to generate (1-10)</div>
                            </div>

                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="use_context" name="use_context" 
                                           {% if use_context %}checked{% endif %}>
                                    <label class="form-check-label" for="use_context">
                                        Use previously reformatted questions as context
                                    </label>
                                </div>
                                <div class="form-text">
                                    When enabled, the AI will learn from existing reformatted questions to maintain consistency.
                                    <br>Currently <strong>{{ reformatted_count }}</strong> questions have the "Reformatted with AI" tag.
                                </div>
                            </div>

                            <div class="mb-3" id="context_limit_group" {% if not use_context %}style="display: none;"{% endif %}>
                                <label for="context_limit" class="form-label">Context Limit</label>
                                <input type="number" class="form-control" id="context_limit" name="context_limit" 
                                       min="1" value="{{ context_limit }}" required>
                                <div class="form-text">Maximum number of previous examples to use as context (minimum 1, no upper limit)</div>
                            </div>

                            <button type="submit" name="save_reformatting_options" class="btn btn-primary">Save Options</button>
                        </form>
                    </div>
                </div>

                <!-- Prompt Settings -->
                <div class="card settings-section">
                    <div class="card-header bg-secondary text-white">
                        <h5 class="mb-0">AI Prompt Settings</h5>
                    </div>
                    <div class="card-body">
                        <form method="post" onsubmit="return confirm('Are you sure you want to save this prompt? The previous one will be permanently replaced.');">
                            <div class="mb-3">
                                <label for="prompt" class="form-label">AI Reformatting Prompt</label>
                                <textarea class="form-control" id="prompt" name="prompt" rows="15">{{ prompt }}</textarea>
                                <div class="form-text">
                                    Edit the prompt used for AI reformulations. Use placeholders like <code>{correct_answer}</code>, <code>{question_body}</code>, and <code>{answers_json}</code>.
                                </div>
                            </div>
                            
                            <div class="alert alert-warning">
                                <strong>Warning:</strong> Modifying the prompt can significantly affect the quality and format of AI reformulations.
                            </div>

                            <button type="submit" name="save_prompt" class="btn btn-warning">Save Prompt</button>
                        </form>
                    </div>
                    </div>
                </div>

            <div class="col-md-6">
                <!-- File Downloads -->
                <div class="card settings-section">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">Download Data Files</h5>
                    </div>
                    <div class="card-body">
                        <p>Download your current data files for backup or sharing:</p>
                        <div class="d-grid gap-2">
                            <a href="/download_questions" class="btn btn-outline-success">
                                Download Questions Database (questions.json)
                            </a>
                            <a href="/download_tags" class="btn btn-outline-success">
                                Download Tags & Chapters (tags_and_chapters.json)
                            </a>
                    </div>
                </div>
            </div>

                <!-- Upload Questions -->
                <div class="card settings-section">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="mb-0">Upload Questions Database</h5>
                    </div>
                    <div class="card-body">
                        <form method="post" enctype="multipart/form-data">
                            <div class="mb-3">
                                <label for="questions_file" class="form-label">Upload New Questions File</label>
                                <input type="file" class="form-control" id="questions_file" name="questions_file" accept=".json" required>
                                <div class="form-text">Upload a JSON file containing questions. This will replace your current questions database.</div>
                            </div>
                            
                            <div class="alert alert-warning">
                                <strong>Warning:</strong> This will replace your current questions database. Make sure to download a backup first.
                            </div>
                            
                            <button type="submit" class="btn btn-warning">Upload Questions</button>
                        </form>
                    </div>
                </div>

                <!-- Upload Tags & Chapters -->
                <div class="card settings-section">
                    <div class="card-header bg-secondary text-white">
                        <h5 class="mb-0">Upload Tags & Chapters</h5>
                    </div>
                    <div class="card-body">
                        <form method="post" enctype="multipart/form-data">
                            <div class="mb-3">
                                <label for="tags_file" class="form-label">Upload Tags & Chapters File</label>
                                <input type="file" class="form-control" id="tags_file" name="tags_file" accept=".json" required>
                                <div class="form-text">Upload a JSON file containing tags and chapters. This will replace your current tag configuration.</div>
                            </div>
                            
                            <div class="alert alert-info">
                                <strong>Note:</strong> This will replace your current tags and chapters configuration. Questions will remain unchanged.
                            </div>
                            
                            <button type="submit" class="btn btn-secondary">Upload Tags & Chapters</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-12">
                <div class="alert alert-info">
                    <h6><strong>File Format Information:</strong></h6>
                    <ul class="mb-0">
                        <li><strong>Questions File:</strong> Should be a JSON array of question objects with body, answers, correct_answer, topic, category, year, and optional tags fields.</li>
                        <li><strong>Tags & Chapters File:</strong> Should be a JSON object with "tags" and "chapters" keys. See the downloaded file for the exact format.</li>
                        <li><strong>Backward Compatibility:</strong> The system automatically synchronizes tags when you upload questions files from previous versions.</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Toggle context limit field visibility
        document.addEventListener('DOMContentLoaded', function() {
            const useContextCheckbox = document.getElementById('use_context');
            const contextLimitGroup = document.getElementById('context_limit_group');
            
            if (useContextCheckbox && contextLimitGroup) {
                useContextCheckbox.addEventListener('change', function() {
                    contextLimitGroup.style.display = this.checked ? 'block' : 'none';
                });
            }
        });
    </script>
</body>
</html> 